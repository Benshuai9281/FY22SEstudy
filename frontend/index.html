<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>お天気情報 | groupH</title>
    <link rel="icon" href="icon.png">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,200;0,400;0,500;0,600;0,700;0,800;0,900;1,800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css" />

    <!-- MQTT over Websocketのライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.527.0.min.js" type="text/javascript"></script>
    
    <!-- REST APIのライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- クライアント実装の読み込み -->
    <script type="text/javascript" src="./js/common.js"></script>
    <script type="text/javascript" src="./js/mqtt_client.js"></script>
    <script type="text/javascript" src="./js/api_client.js"></script>
    <script src="js/script.js" defer></script>
    <script>
        var TMamMicRec=function(control,micOnBtn,recStartBtn,recStopBtn,recMime){
          this.control=control;
          this.micOnBtn   =micOnBtn;
          this.recStartBtn=recStartBtn;
          this.recStopBtn =recStopBtn;
          this.recMime = recMime;
          
          this.stream=null;
          this.mediaRecorder=null;
          this.chunks=[];
          this.recStartBtn.setAttribute("disabled",true);
          this.recStopBtn.setAttribute("disabled",true);
          this.type=null;
          
          this.micOnBtn.addEventListener("click",function(){
            if(navigator.mediaDevices==undefined){
              alert('未対応ブラウザ 又は HTTPS接続していません');
              return;
            }
            navigator.mediaDevices.getUserMedia({audio:true})
            .then(function(stream){
              this.stream=stream;
              
              this.mediaRecorder=new MediaRecorder(this.stream);
              this.mediaRecorder.addEventListener("dataavailable",function(event){
                this.chunks.push(event.data);
                console.log(event.data);
              }.bind(this));
              this.mediaRecorder.addEventListener("stop",function(e){
                // audio/webm;codecs=opus audio/ogg; codecs=opus
                this.type=this.chunks[0].type;
                this.recMime.innerHTML=this.type;
                let blob=new Blob(this.chunks,{"type":this.type});
                this.chunks=[];
      
                //録音したblobをDataURIスキームに変換して<audio>タグでそのまま再生する場合
                let fileReaderAudio=new FileReader();
                fileReaderAudio.addEventListener("load",function(event){
                  let audio_play=document.body.querySelector("#audio_play");
                  if(audio_play==null){
                    audio_play=document.createElement("audio");
                    audio_play.setAttribute("controls","true");
                    audio_play.setAttribute("id","audio_play");
                    audio_play.setAttribute("playsinline","");
                    this.control.appendChild(audio_play);
                    //document.getElementById("Control").appendChild(audio_play);
                  }else{
                    audio_play.pause();
                    audio_play.currentTime=0;
                  }
                  audio_play.setAttribute("src",event.target.result);
                  //audio_play.src=this.result;
                  audio_play.load();
                  audio_play.play();
                }.bind(this));
                fileReaderAudio.readAsDataURL(blob);
      
                this.recStartBtn.removeAttribute("disabled");
                this.recStopBtn.setAttribute("disabled",true);
              }.bind(this));
              this.recStartBtn.removeAttribute("disabled");
              this.micOnBtn.setAttribute("disabled",true);
            }.bind(this)).catch(function(e){
              console.log(e);
              document.getElementById("alert").innerHTML=e;
            }.bind(this));
          }.bind(this));
          this.recStartBtn.addEventListener("click",function(){
            this.recStartBtn.setAttribute("disabled", true);
            this.recStopBtn.removeAttribute("disabled");
            this.mediaRecorder.start();
          }.bind(this));
          this.recStopBtn.addEventListener("click",function(){
            this.mediaRecorder.stop();
          }.bind(this));
        }
        window.addEventListener("DOMContentLoaded",function(){
          mamMicRec=new TMamMicRec(
            document.getElementById("Control"),
            document.getElementById("MicOn"),
            document.getElementById("RecStart"),
            document.getElementById("RecStop"),
            document.getElementById("RecMime")
          );
        });
      </script>
</head>

<body onload="myFunction()">
    <script>
        mqttConnect();
        </script>

<script>
    getDatetime()
    </script>
    <div id="loading"></div>

    
    <div class="set">
        <div class="card2">
            <h2>-- 設定 --</h2> 
            <div class="search">
                <input type="text" class="search-bar" placeholder="住んでいる市町村を入力（ローマ字）" />
                <button>
                    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em"
                    width="1.5em" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                            d="M10.442 10.442a1 1 0 011.415 0l3.85 3.85a1 1 0 01-1.414 1.415l-3.85-3.85a1 1 0 010-1.415z"
                            clip-rule="evenodd"></path>
                            <path fill-rule="evenodd"
                            d="M6.5 12a5.5 5.5 0 100-11 5.5 5.5 0 000 11zM13 6.5a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
                <button id="MicOn">Mic</button><br/>
            </div>

        </div>
    
    </div>


    <div class="cont">
        <div class="one">
            <h2>☁ お天気情報 ☁</h2>
            <h2 id="info"></h2>
        </div>
    </div>
    <h3 class="mirai" id="gotDatetime"></h3>
    <h3 class="mirai" id="status">Connection Status: Not Connected</h3>
    <h3 class="mirai" id="messages"></h3>

    <!-- MQTTブローカーに接続 -->
    
    
    <div class="two">
        <div class="weather loading">
            <div class="card">
                <div class="other">　</div>
                <h2 class="city">Weather in Shanghai</h2>
                <div class="flex">
                    <img src="https://openweathermap.org/img/wn/04d.png" alt="" class="icon" />
                    <div class="description"></div>
                </div>
                <h1 class="temp">31°C</h1>
                <!-- <div class="other">
                    <div class="feels_like">体感温度: 30°C</div>
                </div> -->
                <h2 class="mirai">3時間ごとの天気</h2>
                <div class="flex">
                    <div class="container"></div>
                </div>
                <h2 class="mirai2" id="ame"> </h2>
            </div>

            <!--
            <div class="search">
                <input type="text" class="search-bar" placeholder="市町村を入力（ローマ字）" />
                <button>
                    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em"
                    width="1.5em" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd"
                            d="M10.442 10.442a1 1 0 011.415 0l3.85 3.85a1 1 0 01-1.414 1.415l-3.85-3.85a1 1 0 010-1.415z"
                            clip-rule="evenodd"></path>
                            <path fill-rule="evenodd"
                            d="M6.5 12a5.5 5.5 0 100-11 5.5 5.5 0 000 11zM13 6.5a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0z"
                            clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            -->
        </div>
    </div>

    
</div>


    <!--
        <div id="seting"></div>
        <div class="three">
            <div class="set">
                <h2> 設定画面 </h2>
        </div>
    </div>
    <div class="three">
        <div class="name"><a href="https://github.com/KM-SEB2022/seb2022_groupH">~ groupH</a></div>
    </div> -->
    
    <script>
        var preloader = document.getElementById('loading');
        function myFunction() {
            preloader.style.display = 'none';
        }
    </script>
    <script type="text/javascript" src="js/vanilla-tilt.js"></script>
    <script type="text/javascript">
        VanillaTilt.init(document.querySelector(".card"), {
            max: 15,
            glare: true,
            reverse: true,
            "max-glare": 0.5,
            speed: 400
        });
        VanillaTilt.init(document.querySelectorAll(".card"));

    </script>

    <!--
    <script>
        var preloader = document.getElementById('seting');
        function myFunction() {
            preloader.style.display = 'none';
        }
    </script>
    <script type="text/javascript" src="js/vanilla-tilt.js"></script>-->
    <div class="rec" id="Control">
        <button class="rec" id="RecStart">録</button>
        <button class="rec" id="RecStop" disabled>停</button><br>
        <div class="rec" id="RecMime"></div>
    </div>
    <script>document.getElementById("MicOn").click();</script>
</body>

</html>
